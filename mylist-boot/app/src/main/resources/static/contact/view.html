<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>연락처 상세보기</title>
</head>
<body>
  <h1>연락처 상세</h1>
  <form>
    이메일*: <input type="text" id="x-email" readonly><br> 
    이름*: <input type="text" id="x-name"><br>
    전화*: <input type="text" id="x-tel"><br>
    회사: <input type="text" id="x-company"><br>
    별표시(*) 항목은 필수 입력입니다.<br>
    <button type="button" id="x-update-btn">변경</button> <!--일반 버튼으로 하지 않으면 js 말고 html 이 form에서 액션으로 직접 보낸다--> 
    <button type="button" id="x-cancel-btn">취소</button>
    <button type="button" id="x-delete-btn">삭제</button>
  </form>

  <script>


    // 1) URL에서 쿼리 스트링(query string) 을 추출한다.
    // console.log(location.href.indexOf('?'))
    // console.log(location.href.split('?'))
    var arr = location.href.split('?')
    // console.log(arr)
    if(arr.length ==1) { //view를 볼때는 무조건 ?(쿼리스트링이 존재해야하는데 ) 존재하지 않을때 나가라고 하는것이다.
      alert('요청형식이 올바르지 않습니다.!!')
      throw "URL 형식오류" //script 자체를 나가 버리는것이다.
    }
    
    var qs = arr[1]
    console.log(qs)

    // 2) 쿼리 스트링에서 email 값을 추출한다.
    var email = null
    // 복잡한 방법
    // var values = qs.split('&')
    // for (var value of values) {
    //   if(value.startsWith("email=")) {
    //     // console.log(value.split("=")[1])
    //     email = value.split("=")[1]
    //     break
    //   }
    // }

    //쉬운방법 
    var params = new URLSearchParams(qs)
    email = params.get('email')

    if (email == null) {
      alert('이메일 값이 없습니다.')
      throw '파라미터 오류'
    }
    console.log(email)
    
    // 3) 연락처 상세 정보를 화면에 출력하는거
    // var contact = "홍길동,hong@test.com,1111,비트캠프"
    // var values = contact.split(',')
    
    // Event 밖에 둔것은 이벤트 발생 때마다 찾으면 비효율적이여서 밖에 빼둔것이다.
    var nameEl = document.querySelector('#x-name')
    var emailEl = document.querySelector('#x-email')
    var telEl = document.querySelector('#x-tel')
    var companyEl = document.querySelector('#x-company')
    // console.log(nameEl, emailEl, telEl, companyEl)
    // of null 오류: 객체가 없다라는 뜻이다.



    // 4)서버에서 받은 정보를 화면에 출력하기
    fetch(`/contact/get?email=${email}`)
      .then(function(response) {
        return response.text() // get 함수 호출해서 json 인제 text 인제 확인한다!!!!!
      })
      .then(function(result) {
        console.log(result.split(','))
        nameEl.value = result.split(',')[0]
        emailEl.value = result.split(',')[1]
        telEl.value = result.split(',')[2]
        companyEl.value = result.split(',')[3]
      })
  


    document.querySelector('#x-update-btn').addEventListener('click', function() { // 코드정리해서 사용한것이다.
      if (nameEl.value == "" || telEl.value == "") {
        window.alert('필수입력 항목이 비어있습니다.')
        return
      }
      // console.log(nameEl.value, emailEl.value, telEl.value, companyEl.value) 값을 알아내는 방법
      fetch(`/contact/update?name=${nameEl.value}&email=${emailEl.value}&tel=${telEl.value}&company=${companyEl.value}`)
      .then(function(resoponse) {
        return resoponse.text() // json 형식에서는 문자열 양 쪽에 반드시 "" 이 붙어 있어야한다. , 서버에서 받은 json 형식 문자열을 ==> 자바스크립트 문자열 객체로 변환
        // 문자열은 "" 이 있어야하고
        // 객체는 {}
        // 배열은 []
        // 숫자는 그냥 123 이런식으로 json 이여야 서버에서 json 형태로 받아서 객체로 바꿀수잇다.
      })
      .then(function(text) {
        console.log(text)
        location.href = 'index.html'
      })
    })

    document.querySelector('#x-cancel-btn').addEventListener('click', function() { //코드정리해서 사용한것이다.
      location.href = 'index.html'
    })
    document.querySelector('#x-delete-btn').addEventListener('click', function() {
      fetch(`/contact/delete?email=${emailEl.value}`)
        .then(function(response) {
          return response.json()
        })
        .then(function(result) {
          console.log(result)
          location.href = 'index.html'
        })
    })
  </script>

</body>
</html>